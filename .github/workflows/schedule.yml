name: Auto Numbers3 with Optuna_v2

on:
  schedule:
    - cron: '0 11 * * 1-5'  # JST 20:00（UTC 11:00）、月〜金
  workflow_dispatch:

permissions:
  contents: write  # GITHUB_TOKENでpush可能に

jobs:
  run-scraper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # rebase/pushのため履歴が必要

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies and headless Chrome
        run: |
          set -e
          sudo apt update
          sudo apt install -y wget unzip xvfb \
            libglib2.0-0 libnss3 libxi6 libxcomposite1 libxss1 \
            libatk-bridge2.0-0 libgtk-3-0 libasound2t64 || sudo apt-get install -y libasound2

          # Install Chrome
          wget -q https://storage.googleapis.com/chrome-for-testing-public/138.0.7204.92/linux64/chrome-linux64.zip
          unzip -q chrome-linux64.zip
          sudo mv chrome-linux64 /opt/chrome
          sudo ln -sf /opt/chrome/chrome /usr/bin/google-chrome

          # Install ChromeDriver
          wget -q https://storage.googleapis.com/chrome-for-testing-public/138.0.7204.92/linux64/chromedriver-linux64.zip
          unzip -q chromedriver-linux64.zip
          sudo mv chromedriver-linux64/chromedriver /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver

      - name: Downgrade pip to stable version
        run: python -m pip install pip==23.3.1

      - name: Install core dependencies
        run: pip install -r requirements_core.txt

      - name: Install heavy dependencies
        run: pip install -r requirements_heavy.txt

      # --- NBSP/TAB/CRLF を除去して IndentationError を予防 ---
      - name: Sanitize source files (remove NBSP/tabs/CRLF)
        shell: bash
        run: |
          python - <<'PY'
          import sys, pathlib, py_compile
          files = ["optuna_search_resumable.py", "numbers3_predictor.py"]
          for p in files:
              path = pathlib.Path(p)
              if not path.exists():
                  continue
              s = path.read_text(encoding="utf-8", errors="ignore")
              s2 = (s.replace("\u00a0", " ")
                      .replace("\t", "    ")
                      .replace("\r\n", "\n")
                      .replace("\r", "\n"))
              if s2 != s:
                  path.write_text(s2, encoding="utf-8")
                  print(f"[fix] normalized whitespace: {p}")
              try:
                  py_compile.compile(str(path), doraise=True)
                  print(f"[ok] compiled: {p}")
              except Exception as e:
                  print(f"[warn] compile failed for {p}: {e}", file=sys.stderr)
          PY

      # ===== スクレイピング & numbers3.csv 更新 =====
      - name: Run scraping script
        run: xvfb-run -a python scrapingnumbers3.py

      - name: Commit and push numbers3.csv if changed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          safe_git_pull_rebase() {
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}"

            # 未ステージ/未追跡の変更がある場合のみ stash
            if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
              git stash push -u -m "ci-temp-$(date +%s)"
              STASHED=1
            else
              STASHED=0
            fi

            git fetch origin
            git checkout "${GITHUB_REF_NAME}"
            git pull --rebase origin "${GITHUB_REF_NAME}"

            if [ "$STASHED" = "1" ]; then
              git stash pop || true
            fi
          }

          safe_git_pull_rebase

          git add numbers3.csv || true
          if git diff --cached --quiet; then
            echo "No changes to numbers3.csv"
          else
            git commit -m "Auto update numbers3.csv [skip ci]"
            git push origin HEAD:"${GITHUB_REF_NAME}"
          fi

      # ===== Optuna: Numbers3_predictions × numbers3.csv で探索 =====
      - name: Run Optuna search (Numbers3)
        env:
          NUMBERS3_CSV: ${{ env.NUMBERS3_CSV }}  # 任意: 別パスを渡す場合
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p optuna_results
          CSV_PATH="${NUMBERS3_CSV:-numbers3.csv}"

          xvfb-run -a python optuna_search_resumable.py \
            --backfill Numbers3_predictions.csv \
            --csv "${CSV_PATH}" \
            --n_trials 80 \
            --out optuna_results/best_params.json \
            --storage sqlite:///optuna_results/optuna_study.db \
            --study_name numbers3_optuna

      - name: Commit Optuna results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          safe_git_pull_rebase() {
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}"
            if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
              git stash push -u -m "ci-temp-$(date +%s)"; STASHED=1
            else
              STASHED=0
            fi
            git fetch origin
            git checkout "${GITHUB_REF_NAME}"
            git pull --rebase origin "${GITHUB_REF_NAME}"
            if [ "$STASHED" = "1" ]; then git stash pop || true; fi
          }

          safe_git_pull_rebase

          git add optuna_results/best_params.json || true
          if git diff --cached --quiet; then
            echo "No Optuna changes."
          else
            git commit -m "Auto update (${GITHUB_REF_NAME}): optuna results [skip ci]"
            git push origin HEAD:"${GITHUB_REF_NAME}"
          fi

      # ===== （任意）diversity.json へ反映：他の処理で参照する場合のみ =====
      - name: Apply best_params to diversity.json
        id: apply-best
        shell: bash
        run: |
          python - <<'PY'
          import json, os, pathlib
          out_dir = pathlib.Path("optuna_results")
          out_dir.mkdir(exist_ok=True, parents=True)
          best_p = out_dir / "best_params.json"
          div_p  = out_dir / "diversity.json"

          best = {}
          if best_p.exists():
              best = json.loads(best_p.read_text(encoding="utf-8"))

          div = {}
          if div_p.exists():
              try:
                  div = json.loads(div_p.read_text(encoding="utf-8"))
              except Exception:
                  div = {}

          # Numbers3 の既定値（best_params が無い場合のフォールバック）
          div.setdefault("max_sim", 0.6)
          for k in ("max_sim","lambda_div","temperature"):
              if k in best:
                  try:
                      div[k] = float(best[k])
                  except Exception:
                      div[k] = best[k]

          topk = int(best.get("topk", os.environ.get("NUMBERS3_TOPK", "5")))
          div_p.write_text(json.dumps(div, ensure_ascii=False, indent=2), encoding="utf-8")

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as g:
              g.write(f"topk={topk}\n")
          PY

      - name: Commit diversity.json (applied best_params)
        if: steps.apply-best.outcome == 'success'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          safe_git_pull_rebase() {
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}"
            if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
              git stash push -u -m "ci-temp-$(date +%s)"; STASHED=1
            else
              STASHED=0
            fi
            git fetch origin
            git checkout "${GITHUB_REF_NAME}"
            git pull --rebase origin "${GITHUB_REF_NAME}"
            if [ "$STASHED" = "1" ]; then git stash pop || true; fi
          }

          safe_git_pull_rebase

          git add optuna_results/diversity.json || true
          if git diff --cached --quiet; then
            echo "No diversity changes."
          else
            git commit -m "Auto update (${GITHUB_REF_NAME}): apply best_params to diversity.json [skip ci]"
            git push origin HEAD:"${GITHUB_REF_NAME}"
          fi

      # ===== 予測（numbers3_predictor.py が best_params.json を自動適用）=====
      - name: Run Numbers3 predictor
        run: xvfb-run -a python numbers3_predictor.py

      # ===== 予測CSVを最大3回（1時間間隔）プッシュ =====
      - name: Push Numbers3_predictions.csv every hour up to 3 times
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        timeout-minutes: 190  # 3時間運転の余裕（単一ジョブ上限に注意）
        run: |
          set -euo pipefail
          safe_git_pull_rebase() {
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}"
            if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
              git stash push -u -m "ci-temp-$(date +%s)"; STASHED=1
            else
              STASHED=0
            fi
            git fetch origin
            git checkout "${GITHUB_REF_NAME}"
            git pull --rebase origin "${GITHUB_REF_NAME}"
            if [ "$STASHED" = "1" ]; then git stash pop || true; fi
          }

          for i in 1 2 3
          do
            echo "[INFO] Hourly Push Attempt $i"

            safe_git_pull_rebase

            git add Numbers3_predictions.csv || true
            if git diff --cached --quiet; then
              echo "No changes to Numbers3_predictions.csv"
            else
              git commit -m "Hourly update Numbers3_predictions.csv [skip ci]"
              git push origin HEAD:"${GITHUB_REF_NAME}"
            fi

            if [ $i -lt 3 ]; then
              echo "Sleeping 1 hour before next push..."
              sleep 3600
            fi
          done

      - name: Commit and push remaining prediction results
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          safe_git_pull_rebase() {
            git config --global user.name "github-actions"
            git config --global user.email "github-actions@github.com"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}"
            if ! git diff --quiet || ! git diff --cached --quiet || [ -n "$(git ls-files --others --exclude-standard)" ]; then
              git stash push -u -m "ci-temp-$(date +%s)"; STASHED=1
            else
              STASHED=0
            fi
            git fetch origin
            git checkout "${GITHUB_REF_NAME}"
            git pull --rebase origin "${GITHUB_REF_NAME}"
            if [ "$STASHED" = "1" ]; then git stash pop || true; fi
          }

          safe_git_pull_rebase

          git add evaluation_result.csv evaluation_summary.txt self_predictions.csv || true
          if git diff --cached --quiet; then
            echo "No changes to evaluation-related files"
          else
            git commit -m "Auto update evaluation and self prediction files [skip ci]"
            git push origin HEAD:"${GITHUB_REF_NAME}"
          fi
